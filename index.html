<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaghetti Diagram Tool</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1>Spaghetti Diagram Tool</h1>
                <div class="header-actions">
                    <input type="file" id="backgroundUpload" accept="image/*,.pdf,application/pdf" class="sr-only">
                    <label for="backgroundUpload" class="btn btn--primary">Upload Background (Image/PDF)</label>
                    <!-- Added Help button -->
                    <button id="openHelp" class="btn btn--outline" title="Help & Shortcuts (?)" aria-haspopup="dialog">Help / ?</button>
                    <div class="btn-group" aria-label="Background Orientation Controls">
                        <button id="rotateLeft" class="btn btn--secondary" title="Rotate Left 90¬∞">‚ü≤</button>
                        <button id="rotateRight" class="btn btn--secondary" title="Rotate Right 90¬∞">‚ü≥</button>
                        <button id="flipH" class="btn btn--secondary" title="Flip Horizontal">‚áÜ</button>
                        <button id="flipV" class="btn btn--secondary" title="Flip Vertical">‚áÖ</button>
                        <button id="resetOrientation" class="btn btn--outline" title="Reset Orientation">Reset</button>
                    </div>
                    <div class="btn-group" aria-label="Zoom Controls">
                        <button id="zoomOut" class="btn btn--secondary" title="Zoom Out">‚àí</button>
                        <button id="zoomIn" class="btn btn--secondary" title="Zoom In">+</button>
                        <button id="resetZoom" class="btn btn--outline" title="Reset Zoom">100%</button>
                        <button id="resetView" class="btn btn--outline" title="Reset View (pan+zoom)">Reset View</button>
                    </div>
                    <button id="clearAll" class="btn btn--secondary">Clear All</button>
                    <button id="exportData" class="btn btn--outline">Export Data</button>
                </div>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3>Tools</h3>
                    <div class="tool-buttons">
                        <button id="selectTool" class="tool-btn active" data-tool="select" data-shortcut="S" title="Select (S)" aria-pressed="true">
                            <span class="tool-icon">‚Üñ</span>
                            Select
                        </button>
                        <button id="pathTool" class="tool-btn" data-tool="path" data-shortcut="P" title="Draw Path (P)" aria-pressed="false">
                            <span class="tool-icon">‚úè</span>
                            Draw Path
                        </button>
                        <button id="zoneTool" class="tool-btn" data-tool="zone" data-shortcut="Z" title="Add Zone (Z)" aria-pressed="false">
                            <span class="tool-icon">‚¨ö</span>
                            Add Zone
                        </button>
                        <button id="obstacleTool" class="tool-btn" data-tool="obstacle" data-shortcut="O" title="Add Obstacle (O)" aria-pressed="false">
                            <span class="tool-icon">‚ö†</span>
                            Add Obstacle
                        </button>
                        <button id="deleteTool" class="tool-btn" data-tool="delete" data-shortcut="D" title="Delete Item (D)" aria-pressed="false">
                            <span class="tool-icon">üóëÔ∏è</span>
                            Delete Item
                        </button>
                    </div>
                </div>
                
                <div class="sidebar-section" id="objectsSection">
                    <h3>Objects</h3>
                    <div id="objectPalette" class="object-palette">
                        <!-- Object templates will be populated here -->
                        <div class="empty-state">No objects yet ‚Äî click items to add them.</div>
                    </div>
                </div>
                
                <div class="sidebar-section" id="scaleSection">
                    <h3>Scale</h3>
                    <div class="form-group">
                        <label class="form-label" for="unitsSelect">Units</label>
                        <select id="unitsSelect" class="form-control">
                            <option value="ft" selected>Feet (ft)</option>
                            <option value="m">Meters (m)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="stepsPerUnit">Steps per unit</label>
                        <input type="number" id="stepsPerUnit" class="form-control" step="0.0001" min="0" placeholder="e.g., 0.4 steps/ft">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="gridCellUnits">Grid cell size (in units)</label>
                        <input type="number" id="gridCellUnits" class="form-control" step="0.01" min="0.01" placeholder="e.g., 1.0 for 1 ft per cell">
                    </div>
                    <div class="btn-group">
                        <button id="calibrateScale" class="btn btn--secondary" title="Click two points to calibrate">Calibrate by Click</button>
                        <button id="resetScale" class="btn btn--outline">Reset Scale</button>
                    </div>
                    <div class="form-group" style="margin-top:6px; display:none" id="calLineToggleWrapper">
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px; user-select:none">
                            <input type="checkbox" id="toggleCalibrationLine" checked style="margin:0" />
                            <span>Show Calibration Line</span>
                        </label>
                    </div>
                    <div class="small text-muted" id="gridScaleInfo" style="margin-top:8px;"></div>
                </div>

                <div class="sidebar-section">
                    <h3>Analytics</h3>
                    <div class="analytics-panel" id="analyticsPanel">
                        <div class="metric">
                            <div class="metric-label">Total Paths</div>
                            <div class="metric-value" id="totalPaths">0</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Total Distance (px)</div>
                            <div class="metric-value" id="totalDistance">0 px</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label" id="totalDistanceUnitsLabel">Total Distance (ft)</div>
                            <div class="metric-value" id="totalDistanceUnits">0 ft</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Total Steps</div>
                            <div class="metric-value" id="totalSteps">0</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Weighted Cost</div>
                            <div class="metric-value" id="weightedCost">0</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Avg Path Length (px)</div>
                            <div class="metric-value" id="avgPathLength">0 px</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Most Visited Areas</h3>
                    <div class="hotspot-list" id="hotspotList">
                        <div class="empty-state">No paths drawn yet</div>
                    </div>
                </div>

                <div class="sidebar-section" id="zonesSection">
                    <h3>Zones</h3>
                    <div id="zoneList" class="hotspot-list">
                        <div class="empty-state">No zones yet</div>
                    </div>
                </div>

                <div class="sidebar-section" id="autoPathSection">
                    <h3>Auto Path</h3>
                    <div class="form-group">
                        <label class="form-label" for="autoPathStart">From</label>
                        <select id="autoPathStart" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="autoPathEnd">To</label>
                        <select id="autoPathEnd" class="form-control"></select>
                    </div>
                    <!-- New configuration controls -->
                    <div class="form-group" style="display:flex;gap:6px;align-items:flex-end;flex-wrap:wrap">
                        <div style="flex:1 1 90px;min-width:90px">
                            <label class="form-label" for="autoPathCellSize">Grid (px)</label>
                            <input type="number" id="autoPathCellSize" class="form-control" min="5" step="5" value="20" title="A* grid cell size in pixels (smaller = finer, slower)">
                        </div>
                        <div style="flex:1 1 110px;min-width:110px">
                            <label class="form-label" for="autoPathProximity">Prox Weight</label>
                            <input type="number" id="autoPathProximity" class="form-control" min="0" step="0.1" value="0" title="Extra cost for cells near obstacles (0 = off)">
                        </div>
                        <div style="flex:1 1 140px;min-width:140px">
                            <label class="form-label" for="autoPathSmoothing">Smoothing</label>
                            <select id="autoPathSmoothing" class="form-control" title="Corner smoothing method">
                                <option value="rounded" selected>Rounded</option>
                                <option value="catmull">Catmull-Rom</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="generateAutoPath" class="btn btn--primary" title="Generate obstacle‚Äëavoiding route" disabled>Generate Auto Path</button>
                    </div>
                    <small class="text-muted" style="display:block;margin-top:6px;line-height:1.2">Uses A* routing avoiding objects & obstacles with optional proximity weighting, then smoothing.</small>
                </div>
            </aside>

            <!-- Main Canvas Area -->
            <main class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="workspaceCanvas" width="1000" height="700"></canvas>
                    <div class="canvas-overlay" id="canvasOverlay"></div>
                </div>
                <div class="canvas-info">
                    <!-- Active tool indicator added -->
                    <span id="activeToolIndicator" aria-live="polite">Active Tool: Select (S)</span> ‚Ä¢
                    <span id="canvasInfo">Click and drag to interact with objects. Use tools from the sidebar.</span>
                </div>
            </main>
        </div>

        <!-- Path Side Panel (inline editor after drawing) -->
        <div id="pathSidePanel" class="path-side-panel hidden" aria-label="Path Details" aria-live="polite">
            <div class="path-panel-header">
                <h3 class="path-panel-title">Path Details</h3>
                <button id="pathPanelClose" class="panel-close-btn" title="Close">√ó</button>
            </div>
            <form id="pathPanelForm" class="path-panel-body" autocomplete="off">
                <div class="form-group">
                    <label class="form-label" for="pathPanelDescription">Description</label>
                    <input type="text" id="pathPanelDescription" class="form-control" placeholder="Path description" />
                </div>
                <div class="form-group" style="display:flex; gap:8px; align-items:flex-end;">
                    <div style="flex:1 1 50%">
                        <label class="form-label" for="pathPanelFrequency">Daily Frequency</label>
                        <input type="number" id="pathPanelFrequency" class="form-control" min="1" />
                    </div>
                    <div style="flex:1 1 50%">
                        <label class="form-label" for="pathPanelColor">Color</label>
                        <input type="color" id="pathPanelColor" class="form-control" style="padding:4px; height:40px" />
                    </div>
                </div>
                <div class="small text-muted" style="margin-top:4px; line-height:1.3">
                    Press Enter to save. Draw another path to auto‚Äësave defaults. Double‚Äëclick a path (Select tool) to edit again.
                </div>
                <div class="path-panel-footer">
                    <button type="button" class="btn btn--outline" id="pathPanelCloseFooter">Close</button>
                    <button type="submit" class="btn btn--primary" id="pathPanelSave">Save</button>
                </div>
            </form>
        </div>

        <!-- Path Metadata Modal -->
        <div class="modal hidden" id="pathModal" role="dialog" aria-modal="true" aria-labelledby="pathModalTitle">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="pathModalTitle">Path Details</h3>
                    <button class="modal-close" id="closePathModal" aria-label="Close Path Details">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="pathForm">
                        <div class="form-group">
                            <label class="form-label" for="pathDescription">Description</label>
                            <input type="text" id="pathDescription" class="form-control" 
                                   placeholder="e.g., Walk from Desk to Machine A" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="pathFrequency">Daily Frequency</label>
                            <input type="number" id="pathFrequency" class="form-control" 
                                   placeholder="Number of times per day" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="pathColor">Path Color</label>
                            <select id="pathColor" class="form-control">
                                <option value="#FF0000">Red</option>
                                <option value="#00FF00">Green</option>
                                <option value="#0000FF">Blue</option>
                                <option value="#FFA500">Orange</option>
                                <option value="#800080">Purple</option>
                                <option value="#FFFF00">Yellow</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" id="cancelPath">Cancel</button>
                    <button type="submit" form="pathForm" class="btn btn--primary" id="savePath">Save Path</button>
                </div>
            </div>
        </div>

        <!-- Zone Details Modal -->
        <div class="modal hidden" id="zoneModal" role="dialog" aria-modal="true" aria-labelledby="zoneModalTitle">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="zoneModalTitle">Zone Details</h3>
                    <button class="modal-close" id="closeZoneModal" aria-label="Close Zone Details">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="zoneForm">
                        <div class="form-group">
                            <label class="form-label" for="zoneName">Name</label>
                            <input type="text" id="zoneName" class="form-control" placeholder="e.g., Green Relocation Zone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="zoneType">Type</label>
                            <select id="zoneType" class="form-control" required>
                                <option value="green" selected>Green (OK to move)</option>
                                <option value="restricted">Restricted (No-go)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" id="deleteZone">Delete Zone</button>
                    <button type="submit" form="zoneForm" class="btn btn--primary" id="saveZone">Save</button>
                </div>
            </div>
        </div>

        <!-- Object Details Modal -->
        <div class="modal hidden" id="objectModal" role="dialog" aria-modal="true" aria-labelledby="objectModalTitle">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="objectModalTitle">Object Details</h3>
                    <button class="modal-close" id="closeObjectModal" aria-label="Close Object Details">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="objectForm">
                        <div class="form-group">
                            <label class="form-label" for="objectName">Name</label>
                            <input type="text" id="objectName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="objectType">Type</label>
                            <select id="objectType" class="form-control" required>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" id="deleteObject">Delete Object</button>
                    <button type="submit" form="objectForm" class="btn btn--primary" id="updateObject">Update</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay hidden" id="loadingOverlay" aria-live="polite" aria-busy="false">
            <div class="loading-spinner" role="status" aria-label="Loading"></div>
            <div class="loading-text">Processing...</div>
        </div>

        <!-- Calibration Modal -->
        <div class="modal hidden" id="calibrateModal" role="dialog" aria-modal="true" aria-labelledby="calibrateModalTitle">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="calibrateModalTitle">Set Scale</h3>
                    <button class="modal-close" id="closeCalibrateModal" aria-label="Close Calibration">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="calibrateInfo">Measured pixel distance: 0 px</p>
                    <div class="form-group">
                        <label class="form-label" for="calibrateDistance">Real distance (<span id="calibrateUnits">ft</span>)</label>
                        <input type="number" id="calibrateDistance" class="form-control" min="0.0001" step="0.0001" placeholder="e.g., 10" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" id="redoCalibration">Redo Points</button>
                    <button type="button" class="btn btn--secondary" id="cancelCalibration">Cancel</button>
                    <button type="button" class="btn btn--primary" id="confirmCalibration">Apply</button>
                </div>
            </div>
        </div>

        <!-- Help / Shortcuts Modal -->
        <div class="modal hidden" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
            <div class="modal-content" style="max-width:600px">
                <div class="modal-header">
                    <h3 id="helpModalTitle">Help & Shortcuts</h3>
                    <button class="modal-close" id="closeHelpModal" aria-label="Close Help">&times;</button>
                </div>
                <div class="modal-body">
                    <p><strong>Quick Start:</strong></p>
                    <ol>
                        <li>Upload a background image or PDF.</li>
                        <li>Calibrate scale (optional but recommended).</li>
                        <li>Add objects from the palette.</li>
                        <li>Draw paths between objects.</li>
                        <li>View analytics & export data.</li>
                    </ol>
                    <hr>
                    <p><strong>Keyboard Shortcuts:</strong></p>
                    <ul style="columns:2; list-style:none; padding:0; margin:0; font-size:14px;">
                        <li><kbd>S</kbd> Select Tool</li>
                        <li><kbd>P</kbd> Path Tool</li>
                        <li><kbd>O</kbd> Obstacle Tool</li>
                        <li><kbd>D</kbd> Delete Tool</li>
                        <li><kbd>Esc</kbd> Cancel drawing / close modal</li>
                        <li><kbd>?</kbd> Toggle Help</li>
                        <li><kbd>Del</kbd> Delete selected object</li>
                        <li><kbd>Ctrl/Cmd + Wheel</kbd> Zoom (if supported)</li>
                    </ul>
                    <hr>
                    <p><strong>Tips:</strong> Double‚Äëclick an object in Select mode to edit. Use Delete tool for safer deletions with confirmation.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--primary" id="closeHelpFooter">Close</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal hidden" id="deleteModal" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="deleteModalTitle">Confirm Delete</h3>
                    <button class="modal-close" id="closeDeleteModal" aria-label="Close Delete Confirmation">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage"></p>
                    <p id="deleteWarning" class="text-warning hidden" style="color: var(--color-warning, #ed6c02); font-weight: 500;"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary" id="cancelDelete">Cancel</button>
                    <button type="button" class="btn btn--danger" id="confirmDelete" style="background: var(--color-error, #d32f2f);">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simplified PDF.js static includes for reliability -->
    <script src="libs/pdfjs/pdf.min.js"></script>
    <script>
      console.log('[PDF Init] Checking PDF.js availability...');
      if (window.pdfjsLib) {
        console.log('[PDF Init] pdfjsLib found:', pdfjsLib.version);
        try { 
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdfjs/pdf.worker.min.js'; 
          console.log('[PDF Init] Worker source set successfully');
        } catch (e) { 
          console.warn('[PDF Init] Failed to set PDF worker src', e); 
        }
      } else {
        console.error('[PDF Init] pdfjsLib not loaded. Check if libs/pdfjs/pdf.min.js is accessible.');
      }
      
      // Test if files are accessible
      console.log('[PDF Init] Testing file accessibility...');
      fetch('libs/pdfjs/pdf.min.js', { method: 'HEAD' })
        .then(response => console.log('[PDF Init] pdf.min.js accessible:', response.ok))
        .catch(e => console.error('[PDF Init] pdf.min.js not accessible:', e));
      fetch('libs/pdfjs/pdf.worker.min.js', { method: 'HEAD' })
        .then(response => console.log('[PDF Init] pdf.worker.min.js accessible:', response.ok))
        .catch(e => console.error('[PDF Init] pdf.worker.min.js not accessible:', e));
    </script>
    <script src="app.js"></script>
    <!-- Enhanced features - Phase 1 -->
    <!-- <script src="app_enhanced.js"></script> -->
</body>
</html>
